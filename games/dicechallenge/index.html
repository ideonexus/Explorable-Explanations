<html>
  <head>
    <title>Dice Challenge</title>
  </head>
<!--
Wishlist:
Allow for zero-sided dice for sets that always get initiative.
Other dice types: reserve, etc
-->
 <style>
    body {
        background-color: #320032;
        color: white;
        font-family: sans-serif;
    }

    a {
      color: white;
    }

    h1, h2, h5 {
      width: 100%;
      text-align: center;
      class: block;
    }

    h3 {
      font-size: 1.5em;
    }

    .container {
      width: 890px;
      margin: auto;
    }

    .gameBoard {
      width: fit-content;
      -moz-border-radius:6px;
      -webkit-border-radius:6px;
      border-radius: 6px;
      border: 1px solid #3866a3;
      text-align: center;
      padding: 10px;
      display: flex;
      align-items: top;
      border: 5px solid purple;
      padding: 10px;
      margin: auto;
    }

    .playerStats {
      display: inline-block;
      padding: 10px;
      border: 3px solid #3866a3;
    }

    .diceValueLi {
      border: 3px solid transparent;
      padding-top: 13px;
      padding-bottom: 13px;
      cursor: pointer;

      font-family: sans-serif;
      font-size: 60px;
      width: 100px;
    }

    .diceValueLi:hover {
      border: 3px solid blue;
    }

    .diceDisplay {
      display: inline-block;      
      padding: 10px;
      border: 1px solid #3866a3;
    }

    .diceValueDisplay {
      display: inline-block;      
      padding: 10px;
      border: 1px solid #3866a3;

    }

    .gameBoard ol {
        padding-inline-start: 0px;
        height: 100px;
        width: 100px;
    }

    .gameBoard li {
        list-style-type: none;
    }

    .labelhighlight {
        border: 3px solid yellow;
    }

    .playerhighlight {
        border: 3px solid yellow;
        background-color: #1b7f1f;
    }

    .opponenthighlight {
        border: 3px solid white;
        background-color: darkred;
    }

    #footer {
        width: 90%;
        text-align: center;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        margin: auto;
    }

    .center {
        width: 100%;
        text-align: center;
    }

    span.score { 
        font-size: 3em;
        font-weight: bold;
        line-height: normal;
        width: 100%;
    }

    .selected {
        background-color: yellow;
        color: black;
    }

    select
    {
        font-size:2em;
        font-weight: bold;
        -webkit-appearance: none;
    }

    .headerSelect {
        font-size: 1em;
    }

/* Popup container - can be anything you want */
.popup., .rulespopup {
  position: relative;
  display: inline-block;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* The actual popup */
.popup .popuptext, .rulespopup .rulestext {
  visibility: hidden;
  font-size: 4em;
  width: 550px;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  position: absolute;
  z-index: 1;
  top: 250px;
  margin-left: 225px;
}

.rulespopup .rulestext {
  top: 100px;
}

.rulespopup .rulestext h3 {
    text-align: center;
}

/* The actual popup */
.rulespopup .rulestext {
  text-align: left;
  font-size: 1em;
  line-height: 2em;
}

.popup .show, .rulespopup .show {
  visibility: visible;
  -webkit-animation: fadeIn 1s;
  animation: fadeIn 1s;
}

@-webkit-keyframes fadeIn {
  from {opacity: 0;} 
  to {opacity: 1;}
}

@keyframes fadeIn {
  from {opacity: 0;}
  to {opacity: 1 ;}
}

.myButton {
  -moz-box-shadow:inset 0px 1px 0px 0px #bee2f9;
  -webkit-box-shadow:inset 0px 1px 0px 0px #bee2f9;
  box-shadow:inset 0px 1px 0px 0px #bee2f9;
  background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #63b8ee), color-stop(1, #468ccf));
  background:-moz-linear-gradient(top, #63b8ee 5%, #468ccf 100%);
  background:-webkit-linear-gradient(top, #63b8ee 5%, #468ccf 100%);
  background:-o-linear-gradient(top, #63b8ee 5%, #468ccf 100%);
  background:-ms-linear-gradient(top, #63b8ee 5%, #468ccf 100%);
  background:linear-gradient(to bottom, #63b8ee 5%, #468ccf 100%);
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#63b8ee', endColorstr='#468ccf',GradientType=0);
  background-color:#63b8ee;
  -moz-border-radius:6px;
  -webkit-border-radius:6px;
  border-radius:6px;
  border:1px solid #3866a3;
  display:inline-block;
  cursor:pointer;
  color:#14396a;
  font-family:Arial;
  font-size:15px;
  font-weight:bold;
  padding:6px 24px;
  text-decoration:none;
  text-shadow:0px 1px 0px #7cacde;
}
.myButton:hover {
  background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #468ccf), color-stop(1, #63b8ee));
  background:-moz-linear-gradient(top, #468ccf 5%, #63b8ee 100%);
  background:-webkit-linear-gradient(top, #468ccf 5%, #63b8ee 100%);
  background:-o-linear-gradient(top, #468ccf 5%, #63b8ee 100%);
  background:-ms-linear-gradient(top, #468ccf 5%, #63b8ee 100%);
  background:linear-gradient(to bottom, #468ccf 5%, #63b8ee 100%);
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#468ccf', endColorstr='#63b8ee',GradientType=0);
  background-color:#468ccf;
}
.myButton:active {
  position:relative;
  top:1px;
}


@media only screen and (max-height : 800px) {

}


@media only screen and (max-height : 600px) {

}

@media only screen and (max-width: 800px) {

}

@media only screen and (max-width: 600px) {

}

</style>
<script src="js/jquery-1.9.1.min.js"></script>
<script>
//Math Sets
//https://buttonmen.fandom.com/wiki/The_Math_Set
//Dice Types
//https://buttonmen.fandom.com/wiki/Button_Men_Rules#Chart_of_Button_Men_Online_Dice_Symbols
  var playerChoices = {
    'Abundant 5-104': {'Dice': [12, 18, 20, 24, 30]}
    ,'Buckminster 4-62': {'Dice': [6, 10, 15, 31]}
    ,'Cage 5-84':{'Dice': [6, 10, 14, 24, 30]}
    ,'Composite 5-37': {'Dice': [4, 6, 8, 9, 10]}
    ,'Descartes 5-45': {'Dice': [5, 8, 8, 12, 12]}
    ,'Difference 5-43': {'Dice': [2, 3, 8, 10, 20]}
    //,'Farey': {'Dice': [0, 1, 1, 2, 1]}
    ,'Fibonacci 5-50': {'Dice': [3, 5, 8, 13, 21]}
    ,'Fibonacci 6-52': {'Dice': [2, 3, 5, 8, 13, 21]}
    ,'Heegner 6-43': {'Dice': [1, 2, 3, 7, 11, 19]}
    ,'Looney 5-85': {'Dice': [7, 11, 13, 17, 37]}
    ,'Narayana 5-55': {'Dice': [3, 6, 10, 15, 21]}
    ,'Narayana 7-84': {'Dice': [1, 3, 6, 10, 15, 21, 28]}
    ,'Oblong 5-70': {'Dice': [2, 6, 12, 20, 30]}
    ,'Orchard 5-66': {'Dice': [4, 5, 7, 22, 28]}
    ,'Pascal 5-34': {'Dice': [4, 6, 4, 10, 10]}
    ,'Pascal 6-54': {'Dice': [4, 6, 4, 10, 10, 20]}
    ,'Pell 5-49': {'Dice': [1, 2, 5, 12, 29]}
    ,'Platonic 5-50': {'Dice': [4, 6, 8, 12, 20]}
    ,'Polite 5-30': {'Dice': [3, 5, 6, 7, 9]}
    ,'Primes 5-39': {'Dice': [3, 5, 7, 11, 13]}
    ,'Primes 7-58': {'Dice': [2, 3, 5, 7, 11, 13, 17]}
    ,'Pythagorus 5-37': {'Dice': [3, 4, 5, 9, 16]}
    ,'Pythagorus 6-62': {'Dice': [3, 4, 5, 9, 16, 25]}
    ,'Social Golfers 5-50': {'Dice': [4, 5, 5, 16, 20]}
    ,'Tetrahedral 5-70': {'Dice': [1, 4, 10, 20, 35]}
    ,'Triangular 5-35': {'Dice': [1, 3, 6, 10, 15]}
    ,'Triangular 6-56': {'Dice': [1, 3, 6, 10, 15, 21]}
    ,'Vedic 1-108': {'Dice': [108]}
  }

//******************************************
//************* UI ELEMENTS ****************
//******************************************

  var human = {name: "human", dice: [], results: [], captured: []};
  var ai = {name: "ai", dice: [], results: [], captured: []};
  var currentPlayer = "human";
  var gameHistory = "";
  var round = 1;
  var animatingBlock = false;
  var humanRoundsWon = aiRoundsWon = 0;

  function getRandomColor() 
  {
      var letters = '0123456789ABCDEF'.split('');
      var color = '#';
      for (var i = 0; i < 6; i++ ) {
        //* 10 + 3 sets colors to lighter-end of spectrum for contrast
          color += letters[Math.floor(Math.random() * 10) + 3];
      }
      return color;
  }

  //http://www.storminthecastle.com/2013/07/24/how-you-can-draw-regular-polygons-with-the-html5-canvas-api/
  var polygon = function(ctx, x, y, radius, sides, startAngle, anticlockwise) 
  {
      if (sides < 3) return;
      let a = (Math.PI * 2)/sides;
      a = anticlockwise?-a:a;
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(startAngle);
      ctx.moveTo(radius,0);
      for (let i = 1; i < sides; i++) {
          ctx.lineTo(radius*Math.cos(a*i),radius*Math.sin(a*i));
      }
      ctx.closePath();
      ctx.restore();
  }

  // Function to generate AI dice
  var setPlayerDice = function(player) 
  {
      let diceDisplay = "#" + player + "Dice";
      let diceValues = "#" + player + "DiceValues";
      let actingOnPlayer = (player == "human") ? human : ai;
      actingOnPlayer.dice = [];
      actingOnPlayer.results = [];

      // Populate Dice Displays
      let playerSelection = $("#" + player + "Choices").val();
      let playerDice = playerChoices[playerSelection]["Dice"];
      let diceSidesDisplay = "";
      let diceOutputDisplay = "";
      for (let i = 0; i < playerDice.length; i++) {
          diceSidesDisplay += "<ol class=\"clear\">";
          diceSidesDisplay += "<li>";
          diceSidesDisplay += "<canvas id=\"" + player + "Die_" + i + "\"></canvas>";
          diceSidesDisplay += "</li>";
          diceSidesDisplay += "</ol>";

          //Generate the random value for each die
          var dieResult = (Math.floor(Math.random() * playerDice[i]) + 1);
          actingOnPlayer.dice.push(playerDice[i]);
          actingOnPlayer.results.push(dieResult);

          diceOutputDisplay += "<ol class=\"clear\">";
          diceOutputDisplay += "<li id=\"" + player + "Val_" + i + "\" class=\"diceValueLi\">";
          diceOutputDisplay += dieResult;
          diceOutputDisplay += "</li>";
          diceOutputDisplay += "</ol>";
      }

      $(diceDisplay).html(diceSidesDisplay);
      $(diceValues).html(diceOutputDisplay);

      // Draw a Polygon to represent the die
      for (let i = 0; i < playerDice.length; i++) {
          let canvas = $("#" + player + "Die_" + i)[0];
          canvas.width = 100;
          canvas.height = 100;
          let ctx = canvas.getContext("2d");
          ctx.fillStyle = getRandomColor();
          canvas.style.background = '#320032';
          polygon(ctx, 50, 50, 50, playerDice[i], -Math.PI/2);
          ctx.fill();

          const x = canvas.width / 2;
          ctx.fillStyle = (playerDice[i] > 2) ? "black" : "white";
          ctx.font = "bold 60px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText(playerDice[i], x, 70);

          $("#" + player + "Val_" + i).click(function(){ selectDie(player, i) });
       }
  }

  var populatePlayerChoiceOptions = function(player, selection, rng = false)
  {
      let element = $("#" + player + "Choices");
      if ($(element).find("option").length === 0)
      {
          $.each(playerChoices, function (i, item) {
              element.append($('<option>', { 
                  value: i,
                  text : i
              }));
          });
      }

      if (rng) 
      {
          // Set to random selection initially
          var keys = Object.keys(playerChoices);
          var rngKey = keys[keys.length * Math.random() << 0];
          $(element).val(rngKey);
      }
      else if (selection != '')
      {
          $(element).val(selection);         
      }

      $(element).change(function() {
          setPlayerDice(player);
          //newGame();
      });
  }

//******************************************
//************* UTILITIES *****************
//******************************************

  var getCombinations = function(valuesArray)
  {
      var combi = [];
      var temp = [];
      var slent = Math.pow(2, valuesArray.length);

      for (var i = 0; i < slent; i++)
      {
          temp = [];
          for (var j = 0; j < valuesArray.length; j++)
          {
              if ((i & Math.pow(2, j)))
              {
                  temp.push(valuesArray[j]);
              }
          }
          if (temp.length > 0)
          {
              combi.push(temp);
          }
      }

      combi.sort((a, b) => a.length - b.length);
      //console.log(combi.join("\n"));
      return combi;
  }

  var sumArray = function(arr)
  {
      return arr.reduce((partialSum, a) => partialSum + a, 0);
  }

//******************************************
//************* GAME LOGIC *****************
//******************************************

  var diceDuelStart = function() 
  {
      currentPlayer = null;
      human = {name: "human", dice: [], results: [], captured: []};
      ai = {name: "ai", dice: [], results: [], captured: []};
      setPlayerDice("human");
      setPlayerDice("ai");
      round++;
      updatePlayerScores();
      switchPlayer();
      animateRoundAnnouncer(round);
  }  

  var animateRoundAnnouncer = function(round)
  {
      animatingBlock = true;
      $("#roundAnnouncer").html("ROUND " + round);
      $("#roundAnnouncer").addClass("show");

      //Animate Round Display
      let step = 0;
      let animateStep = function()
      {
          switch (step) 
          {
              case 0:
                  $("#roundAnnouncer").html("FIGHT!");
                  break;
              default:
                  $("#roundAnnouncer").removeClass("show");
                  animatingBlock = false;
                  clearInterval(announceAnimation);
                  break;
          }
          step++;
      }
      let announceAnimation = setInterval(animateStep, 1000);
  }

  // Function to change the current player
  var switchPlayer = function() 
  {
      if (!currentPlayer) 
      {
          //Find the the player with the lowest result(s) and make them first to go
          //Shallow copy arrays to prevent sort from acting on originals
          const humanSorted = [...human.results].sort((a, b) => a - b);
          const aiSorted = [...ai.results].sort((a, b) => a - b);
          let i = 0;
          //TODO: This will break if both players roll the same results
          while (!currentPlayer)
          {
              if (i <= humanSorted.length && i <= aiSorted.length)
              {
                  if (humanSorted[i] != aiSorted[i])
                      currentPlayer = (humanSorted[i] < aiSorted[i]) ? "human" : "ai";
                  else
                      i++;
              }
              else //If both results are completely equal, randomize start player
                  currentPlayer = (Math.floor(Math.random() * 2) == 0) ? "human" : "ai";
          }
      }
      else
      {
          //Switch Player
          currentPlayer = (currentPlayer === "human") ? "ai" : "human";
      }

      for (let i = 0; i < human.dice.length; i++) { 
          $("#humanVal_" + i).removeClass("playerhighlight");
          $("#humanVal_" + i).removeClass("opponenthighlight");
      }

      for (let i = 0; i < ai.dice.length; i++) { 
          $("#aiVal_" + i).removeClass("playerhighlight");
          $("#aiVal_" + i).removeClass("opponenthighlight");
      }

      selectedOwnDice = [];
      selectedOppDie = [];

      $("#human").removeClass("labelhighlight");
      $("#humanLabel").removeClass("labelhighlight");
      $("#ai").removeClass("labelhighlight");
      $("#aiLabel").removeClass("labelhighlight");
      $("#" + currentPlayer + "Label").addClass("labelhighlight");
      $("#" + currentPlayer).addClass("labelhighlight");
      //updateGameHistory(currentPlayer.toUpperCase() + "'s turn.");
      if (anyPossiblePlayCheck() && currentPlayer == "ai") playAITurn();
  }

  var playsCheck = 0;
  var anyPossiblePlayCheck = function()
  {
      let activePlayer = (currentPlayer == "human") ? human : ai;
      let inactivePlayer = (currentPlayer == "human") ? ai : human;
      let allPossibleSelections = getCombinations(activePlayer.results);

      if (allPossibleSelections.length > 0)
      {
          for (let i = 0; i < allPossibleSelections.length; i++)
          {
              if (!allPossibleSelections[i].includes(0))
              {
                  for (let j = 0; j < inactivePlayer.results.length; j++)
                  {
                      if (inactivePlayer.results[j] != 0 && sumArray(allPossibleSelections[i]) != 0
                          && ((allPossibleSelections[i].length == 1
                          && allPossibleSelections[i] > inactivePlayer.results[j])
                        || (sumArray(allPossibleSelections[i]) == inactivePlayer.results[j])))
                      {
                          playsCheck = 0;
                          return true;
                      }
                  }
              }
          }
      }

      //No possible moves? Pass turn.
      playsCheck++;
      updateGameHistory(currentPlayer.toUpperCase() + " has no possible plays.");
      if (playsCheck == 2)
      {
          let winner = (parseFloat($("#humanScore").html()) > parseFloat($("#aiScore").html())) ?
              "human" : "ai";
          if (winner == "human")
          {
              humanRoundsWon++;
              $("#humanRoundsTotal").html(humanRoundsWon);
          }
          else
          {
              aiRoundsWon++;
              $("#aiRoundsTotal").html(aiRoundsWon);
          }
          updateGameHistory("=== " + winner.toUpperCase() + " WINS ROUND " + round + " ===");
      }
      else
      {
          setTimeout(function(){
              switchPlayer();
          },1000);
      }
  }

  var playAITurn = function()
  {
      animatingBlock = true;
      let activePlayer = (currentPlayer == "human") ? human : ai;
      let inactivePlayer = (currentPlayer == "human") ? ai : human;
      let allPossiblePlays = [];
      let allPossibleResults = getCombinations(activePlayer.results);
      let allPossibleDice = getCombinations(activePlayer.dice);
      let indexesArray = [];
      for (let i = 0; i < ai.dice.length; i++)
      {
          indexesArray.push(i);
      }
      let allPossibleIndexes = getCombinations(indexesArray);

      //Catalog all possible combinations of captures
      if (allPossibleResults.length > 0)
      {
          for (let i = 0; i < allPossibleResults.length; i++)
          {
              //Filter selections that have zeroed-out dice.
              //TODO: Faster to filter out all results with 0 in them first.
              if (!allPossibleResults[i].includes(0))
              {
                  for (let j = 0; j < inactivePlayer.results.length; j++)
                  {
                      if (inactivePlayer.results[j] != 0 && sumArray(allPossibleResults[i]) != 0
                          && ((allPossibleResults[i].length == 1
                          && allPossibleResults[i] > inactivePlayer.results[j])
                        || (sumArray(allPossibleResults[i]) == inactivePlayer.results[j])))
                      {
                          //Value of die minus the result (ie d20 - 5 = 15) plus oppValue (ie. d15)
                          let rerollAndDieValue = 
                              (sumArray(allPossibleDice[i]) - sumArray(allPossibleResults[i])) 
                              + (inactivePlayer.dice[j] * parseInt($("#aiWeight").val()));
                          //Push to solutions array
                          allPossiblePlays.push({
                              own: i, opp: j, weight: rerollAndDieValue
                          })
                      }
                  }
              }
          }
      }

      //Sort all dice combinations by weight, then Opponent Dice Value
      let bestPlay = null;
      let allPlaysSorted = allPossiblePlays.sort((a, b) => 
          (a.weight < b.weight) ? 1 : 
          (a.weight === b.weight && human.dice[a.opp] < human.dice[b.opp]) ? 1 : -1);

      if ($("#aiDepth").val() == "all")
          bestPlay = allPlaysSorted[0];
      else
          bestPlay = allPlaysSorted.filter((n) => 
              allPossibleResults[n.own].length <= parseInt($("#aiDepth").val()))[0];

      //Play the turn
      let step = 0;
      let animateStep = function()
      {
          if (step < allPossibleResults[bestPlay.own].length)
          {
              selectDie("ai", allPossibleIndexes[bestPlay.own][step], true);
              step++;
          }
          else
          {
              selectDie("human", bestPlay.opp, true);
              step = 0;
              animatingBlock = false;
              clearInterval(selectAnimation);
          }
      }
      let selectAnimation = setInterval(animateStep, 750);
  }

  var selectedOwnDice = [];
  var selectedOppDie = [];
  var selectDie = function(player, row, fromai) 
  {
      // Disable clicks if not player turn
      if (currentPlayer == "ai" && !fromai)
         return false;

      let activePlayer = (currentPlayer == "human") ? human : ai;
      let inactivePlayer = (currentPlayer == "human") ? ai : human;
      let currentElement = $("#" + player + "Val_" + row);

      if (currentPlayer == player)
      {
          if (activePlayer.results[row] == 0) return;
          // If this die is already selected, deselect it
          if (currentElement.hasClass("playerhighlight"))
          {
              currentElement.removeClass("playerhighlight");
              selectedOwnDice.splice(selectedOwnDice.indexOf(row), 1);
          }
          else
          {
              selectedOwnDice.push(row);
              currentElement.addClass("playerhighlight");
          }
      }
      else
      {
          if (inactivePlayer.results[row] == 0) return;
          // If this die is already selected, deselect it
          if (currentElement.hasClass("opponenthighlight"))
          {
              currentElement.removeClass("opponenthighlight");
              selectedOppDie = [];
              return;
          }
          // Check if an opponent die is already selected
          if (selectedOppDie.length > 0) return;
          selectedOppDie.push(row);
          currentElement.addClass("opponenthighlight");
      }

      // Check for die capture
      let selectedOwnDiceResult = activePlayer.results[selectedOwnDice[0]]; 
      if (selectedOwnDice.length > 1) 
      {
          for (let i = 1; i < selectedOwnDice.length; i++)
              selectedOwnDiceResult += activePlayer.results[selectedOwnDice[i]];
      }

      let selectedOppDieResult = inactivePlayer.results[selectedOppDie[0]];
      
      let captured = '';
      if (selectedOwnDice.length == 1 && (selectedOwnDiceResult >= selectedOppDieResult))
          captured = 'power';
      else if (selectedOwnDice.length > 1 && (selectedOwnDiceResult == selectedOppDieResult))
          captured = 'skill';

      if (captured)
      {
          let capturedDie = inactivePlayer.dice[selectedOppDie[0]];
          activePlayer.captured.push(capturedDie);  
          let selectedOwnDiceResultString = "d" + activePlayer.dice[selectedOwnDice[0]]
              + "(" + activePlayer.results[selectedOwnDice[0]] + ")";
          if (selectedOwnDice.length > 1) 
          {
              for (let i = 1; i < selectedOwnDice.length; i++)
              {
                  selectedOwnDiceResult += activePlayer.results[selectedOwnDice[i]];
                  selectedOwnDiceResultString += "+d" + activePlayer.dice[selectedOwnDice[i]]
                      + "(" + activePlayer.results[selectedOwnDice[i]] + ")";
              }
          }
          updateGameHistory(currentPlayer.toUpperCase() + " " 
              + captured + " attacks (" + selectedOwnDiceResultString + ") "
              + player.toUpperCase() + "'s d" + capturedDie + "(" + selectedOppDieResult + ")");

          setTimeout(function(){
              //X-Out the Captured Die 
              let canvas = $("#" + inactivePlayer.name + "Die_" + selectedOppDie[0])[0];
              canvas.width = 100;
              canvas.height = 100;
              let ctx = canvas.getContext("2d");
              ctx.fillStyle = getRandomColor();
              canvas.style.background = '#320032';
              polygon(ctx, 50, 50, 50, capturedDie, -Math.PI/2);
              ctx.fill();

              const x = canvas.width / 2;
              ctx.fillStyle = (capturedDie > 2) ? "black" : "white";
              ctx.font = "bold 60px sans-serif";
              ctx.textAlign = "center";
              ctx.fillText(capturedDie, x, 70);
              ctx.fillStyle = "black";
              ctx.font = "120px sans-serif";
              ctx.fillText("X", x, 92);

              //Zero out the Captured Die
              inactivePlayer.results[selectedOppDie[0]] = 0;
              $("#" + inactivePlayer.name + "Val_" + selectedOppDie[0]).html(0);
              
              //Reroll the spent dice
              let newResult1 = (Math.floor(Math.random() * activePlayer.dice[selectedOwnDice[0]]) + 1);
              activePlayer.results[selectedOwnDice[0]] = newResult1;
              $("#" + currentPlayer + "Val_" + selectedOwnDice[0]).html(newResult1);

              if (selectedOwnDice.length > 1)
              {
                  for (let i = 1; i < selectedOwnDice.length; i++)
                  {
                      let newResult2 = (Math.floor(Math.random() * activePlayer.dice[selectedOwnDice[i]]) + 1);
                      activePlayer.results[selectedOwnDice[i]] = newResult2;
                      $("#" + currentPlayer + "Val_" + selectedOwnDice[i]).html(newResult2);
                  }
              }

              updatePlayerScores();
              switchPlayer();
          }, 500);
      }
  }

  var updatePlayerScores = function()
  {
      //Sum uncaptured dice and divide by 2
      let aiUncaptured = [];
      for (let i = 0; i < ai.results.length; i++) 
          if (ai.results[i] != 0) aiUncaptured.push(ai.dice[i]);

      let aiScore = sumArray(ai.captured) + (sumArray(aiUncaptured)/2)
      $("#aiScore").html(aiScore);
      $("#aiCapturedDice").html(sumArray(ai.captured) + " [" + ai.captured.join(',') + "]");
      $("#aiRetainedDice").html((sumArray(aiUncaptured)/2) + " [" + aiUncaptured.join(',') + "]");

      let humanUncaptured = [];
      for (let i = 0; i < human.results.length; i++) 
          if (human.results[i] != 0) humanUncaptured.push(human.dice[i]);

      let humanScore = sumArray(human.captured) + (sumArray(humanUncaptured)/2)
      $("#humanScore").html(humanScore);
      $("#humanCapturedDice").html(sumArray(human.captured) + " [" + human.captured.join(',') + "]");
      $("#humanRetainedDice").html((sumArray(humanUncaptured)/2) + " [" + humanUncaptured.join(',') + "]");
  }

  var updateGameHistory = function(update) {
      gameHistory = update + "<br>" + gameHistory;
      $("#gameHistory").html(gameHistory);
  }

  var newGame = function()
  {
      if (animatingBlock) return;
      gameHistory = "";
      $("#gameHistory").html("");
      round = 0;
      humanRoundsWon = aiRoundsWon = 0;
      $("#humanRoundsTotal").html(humanRoundsWon);
      $("#aiRoundsTotal").html(aiRoundsWon);
      diceDuelStart();      
  }

  var anotherRound = function()
  {
      if (animatingBlock) return;
      //No new round until current is complete.
      if (playsCheck < 2) return;
      diceDuelStart();      
  }

  var showRules = function()
  {
      $("#rulesbox").addClass("show");
  }

  var closeRules = function()
  {
      $("#rulesbox").removeClass("show");
  }

//********** PAGE INITIALIZATION ***************

  $(document).ready(function() {
      $('#ruleslink').click(function(){ showRules(); return false; });
      $('#closeRuleslink').click(function(){ closeRules(); return false; });
      populatePlayerChoiceOptions("human", "Platonic 5-50");
      populatePlayerChoiceOptions("ai", "Platonic 5-50");
      setPlayerDice("human");
      setPlayerDice("ai");
  });
</script>
  </head>
  <body>
    <h1>
      Dice Challenge
    </h1>
    <h2>
      <button onclick="newGame()" class="myButton">New Game</button>
      <button onclick="anotherRound()" class="myButton">Another Round</button>
      <select id="aiDepth" class="headerSelect">
          <option value="all">AI Depth All</option>
          <option value="4">AI Depth 4</option>
          <option value="3">AI Depth 3</option>          
          <option value="2">AI Depth 2</option>          
      </select>
      <select id="aiWeight" class="headerSelect">
          <option value="1">Weight Points x1</option>
          <option value="1.5">Weight Points x1.5</option>
          <option value="2">Weight Points x2</option>
      </select>
      <a id="ruleslink" href="#">Rules</a>
    </h2>
    <div class="container">
    <div class="rulespopup">
        <span class="rulestext" id="rulesbox">
            <h3>Rules of Play</h3>
            <ol>
              <li>Player with the lowest die result goes first.</li>
              <li>The current player may:
                <ul>
                  <li><b>Power Attack:</b> Choose one die and an opponent's die with a lesser or equal value to capture it.</li>
                  <li><b>Skill Attack:</b> Choose multiple dice and an opponent's die of equal value to capture it.</li>
                </ul>
              </li>
              <li>All chosen dice are re-rolled.</li>
              <li>Switch current player.</li>
              <li>Each captured die is worth points equal to its max value.</li>
              <li>Each retained die is worth points equal to half its max value</li>
            </ol>
            <ul>
              <li><b>AI Depth:</b> maximum dice the AI can choose for a skill shot. Set this lower for an easier AI opponent.</li>
              <li><b>Weight Points:</b> how much the AI will weigh capturing high-value dice for points VS rerolling it's own lower-result dice for value. Makes the AI greedier.</li>
            </ul>
            <h3><a id="closeRuleslink" href="#">close</a></h3>
        </span>
    </div>
    <div class="popup">
        <span class="popuptext" id="roundAnnouncer"></span>
    </div>
    <div class="gameBoard">
      <div id="human" class="playerStats">
        <h2 id="humanLabel">Human</h2>
        <div id="humanPortrait"></div>
        <select id="humanChoices"></select>
        <h3>Captured<br/><span id="humanCapturedDice">[]</span></h3>
        <h3>Remaining<br/><span id="humanRetainedDice">[]</span></h3>
        <h2>Score<br/><span class="score" id="humanScore">0</span></h2>
        <h2>Rounds Won<br/><span class="score" id="humanRoundsTotal">0</span></h2>
      </div>
      <div id="humanDice" class="diceDisplay"></div>
      <div id="humanDiceValues" class="diceValueDisplay"></div>
      <div id="aiDiceValues" class="diceValueDisplay"></div>
      <div id="aiDice" class="diceDisplay"></div>    
      <div id="ai" class="playerStats">
        <h2 id="aiLabel">AI</h2>
        <div id="aiPortrait"></div>
        <select id="aiChoices"></select>
        <h3>Captured<br/><span id="aiCapturedDice">[]</span></h3>
        <h3>Remaining<br/><span id="aiRetainedDice">[]</span></h3>
        <h2>Score<br/><span class="score" id="aiScore">0</span></h2>
        <h2>Rounds Won<br/><span class="score" id="aiRoundsTotal">0</span></h2>
      </div>
    </div>
    <h5 style="color: #ffffff;">Part of the <a href="http://ideonexus.github.io/Explorable-Explanations/">Explorable Explanations</a> collection of educational javascript apps.</h5>
    <h2 id="gameHistory"></h2>
    </div>
  </body>
</html>
